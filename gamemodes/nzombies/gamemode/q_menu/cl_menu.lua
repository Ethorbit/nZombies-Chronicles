function nzQMenu.GetDefaultPropList() -- Moved into function by Ethorbit, so we aren't relying on a file that the client probably doesn't have
	return [[
		"TableToKeyValues"
		{
			"1"
			{
				"tooltip"		"Bushes & Trees"
				"Models"
				{
					"1"		"models/props_foliage/tree_springers_01a-lod.mdl"
					"2"		"models/props_foliage/tree_springers_01a.mdl"
					"3"		"models/props_foliage/tree_springers_card_01_skybox.mdl"
					"4"		"models/props_foliage/bramble001a.mdl"
					"5"		"models/props_foliage/cattails.mdl"
					"6"		"models/props_foliage/driftwood_01a.mdl"
					"7"		"models/props_foliage/driftwood_02a.mdl"
					"8"		"models/props_foliage/driftwood_03a.mdl"
					"9"		"models/props_foliage/driftwood_clump_01a.mdl"
					"10"		"models/props_foliage/driftwood_clump_02a.mdl"
					"11"		"models/props_foliage/driftwood_clump_03a.mdl"
					"12"		"models/props_foliage/ivy_01.mdl"
					"13"		"models/props_foliage/oak_tree01.mdl"
					"14"		"models/props_foliage/shrub_01a.mdl"
					"15"		"models/props_foliage/tree_cliff_01a.mdl"
					"16"		"models/props_foliage/tree_cliff_02a.mdl"
					"17"		"models/props_foliage/tree_deciduous_01a.mdl"
					"18"		"models/props_foliage/tree_deciduous_03a.mdl"
					"19"		"models/props_foliage/tree_deciduous_03b.mdl"
					"20"		"models/props_foliage/tree_poplar_01.mdl"
				}
				"icon"		"icon16/world.png"
				"name"		"Foliage"
			}
			"2"
			{
				"tooltip"		"Fences & Useful Door Props"
				"Models"
				{
					"1"		"models/props_c17/fence03a.mdl"
					"2"		"models/props_c17/fence02b.mdl"
					"3"		"models/props_c17/fence01b.mdl"
					"4"		"models/props_c17/gate_door01a.mdl"
					"5"		"models/props_c17/gate_door02a.mdl"
					"6"		"models/props_building_details/Storefront_Template001a_Bars.mdl"
					"7"		"models/props_borealis/borealis_door001a.mdl"
					"8"		"models/props_wasteland/interior_fence001g.mdl"
					"9"		"models/props_wasteland/interior_fence002d.mdl"
					"10"		"models/props_wasteland/wood_fence01a.mdl"
					"11"		"models/props_lab/blastdoor001a.mdl"
					"12"		"models/props_lab/blastdoor001b.mdl"
					"13"		"models/props_lab/blastdoor001c.mdl"
					"14"		"models/props_wasteland/wood_fence02a.mdl"
					"15"		"models/props_wasteland/prison_celldoor001b.mdl"
					"16"		"models/props_interiors/ElevatorShaft_Door01a.mdl"
					"17"		"models/props_debris/metal_panel01a.mdl"
					"18"		"models/props_debris/metal_panel02a.mdl"
					"19"		"models/props_doors/door03_slotted_left.mdl"
					"20"		"models/props_interiors/VendingMachineSoda01a_door.mdl"
					"21"		"models/props_wasteland/interior_fence002e.mdl"
					"22"		"models/props_interiors/refrigeratorDoor01a.mdl"
					"23"		"models/props_c17/door01_left.mdl"
					"24"		"models/props_c17/door02_double.mdl"
					"25"		"models/props_c17/gravestone_coffinpiece001a.mdl"
					"26"		"models/props_c17/gravestone_coffinpiece002a.mdl"
					"27"		"models/props_junk/TrashDumpster02b.mdl"
				}
				"icon"		"icon16/link_break.png"
				"name"		"Gates"
			}
			"3"
			{
				"tooltip"		"Broken Walls & Debris"
				"Models"
				{
					"1"		"models/props_debris/plaster_wall001a.mdl"
					"2"		"models/props_debris/plaster_wall002a.mdl"
					"3"		"models/props_debris/walldestroyed06b.mdl"
					"4"		"models/props_debris/walldestroyed07b.mdl"
					"5"		"models/props_debris/walldestroyed05a.mdl"
					"6"		"models/props_debris/tile_wall001a.mdl"
					"7"		"models/props_debris/tile_wall001a_base.mdl"
					"8"		"models/lostcoast/props_monastery/destroyed_walls02.mdl"
					"9"		"models/lostcoast/props_monastery/destroyed_walls03.mdl"
					"10"		"models/props_buildings/collapsedbuilding01awall.mdl"
					"11"		"models/props_debris/concrete_section128wall001a.mdl"
					"12"		"models/props_debris/concrete_section128wall001b.mdl"
					"13"		"models/props_debris/concrete_section128wall001c.mdl"
					"14"		"models/props_debris/concrete_section128wall002a.mdl"
					"15"		"models/props_debris/concrete_wall01a.mdl"
					"16"		"models/props_debris/concrete_wall02a.mdl"
					"17"		"models/props_debris/tile_wall001a_core.mdl"
					"18"		"models/props_debris/wall001a_base.mdl"
					"19"		"models/props_debris/walldestroyed01a.mdl"
					"20"		"models/props_debris/walldestroyed02a.mdl"
					"21"		"models/props_debris/walldestroyed03a.mdl"
					"22"		"models/props_debris/walldestroyed08a.mdl"
					"23"		"models/props/cs_militia/bathroomwallhole01_tile.mdl"
					"24"		"models/props/cs_militia/bathroomwallhole01_wood_broken_01.mdl"
					"25"		"models/props/cs_militia/bathroomwallhole01_wood_broken.mdl"
					"26"		"models/props/cs_militia/wallconcretehole.mdl"
					"27"		"models/props_debris/building_brokenexterior001a.mdl"
					"28"		"models/props_debris/building_brokenexterior001b.mdl"
					"29"		"models/props_debris/building_brokenexterior001c.mdl"
					"30"		"models/props_debris/building_brokenexterior002a.mdl"
					"31"		"models/props_debris/building_brokenexterior002b.mdl"
					"32"		"models/props_debris/building_brokenexterior002c.mdl"
					"33"		"models/props_debris/concrete_spawnhole001a.mdl"
					"34"		"models/props_debris/concrete_spawnplug001a.mdl"
					"35"		"models/props_debris/concrete_wall01a.mdl"
					"36"		"models/props_debris/concrete_wall02a.mdl"
					"37"		"models/props_debris/destroyedceiling01a.mdl"
					"38"		"models/props_debris/destroyedceiling01b.mdl"
					"39"		"models/props_debris/destroyedceiling01c.mdl"
					"40"		"models/props_debris/destroyedceiling01d.mdl"
					"41"		"models/props_debris/broken_floor001a.mdl"
					"42"		"models/props_debris/broken_pile001a.mdl"
					"43"		"models/props_debris/barricade_short01a.mdl"
					"44"		"models/props_debris/barricade_short02a.mdl"
					"45"		"models/props_debris/barricade_short03a.mdl"
					"46"		"models/props_debris/barricade_short04a.mdl"
					"47"		"models/props_debris/barricade_tall01a.mdl"
					"48"		"models/props_debris/barricade_tall02a.mdl"
					"49"		"models/props_debris/barricade_tall03a.mdl"
					"50"		"models/props_debris/barricade_tall04a.mdl"
					"51"		"models/props_debris/building_brokenwindow001a.mdl"
					"52"		"models/props_debris/building_brokenwindow001b.mdl"
					"53"		"models/props_unique/zombiebreakwallcoreframe01_dm.mdl"
				}
				"icon"		"icon16/house.png"
				"name"		"Wall Pieces"
			}
			"4"
			{
				"tooltip"		"Dead Corpses & Barbed Wire (Origins)"
				"Models"
				{
					"1"		"models/nzprops/origins/barbwire_blockade.mdl"
					"2"		"models/nzprops/origins/barbwire_long.mdl"
					"3"		"models/nzprops/origins/barbwire_gate.mdl"
					"4"		"models/nzprops/origins/barbwire_tube.mdl"
					"5"		"models/nzprops/origins/sandbag_blockade.mdl"
					"6"		"models/nzprops/origins/originscorpse01.mdl"
					"7"		"models/nzprops/origins/originscorpse02.mdl"
					"8"		"models/nzprops/origins/originscorpse03.mdl"
					"9"		"models/nzprops/origins/originscorpse04.mdl"
					"10"		"models/nzprops/origins/originscorpse04stick.mdl"
					"11"		"models/nzprops/origins/originscorpse05.mdl"
					"12"		"models/nzprops/origins/originscorpse05stick.mdl"
					"13"		"models/props_unique/wooden_barricade.mdl"
					"14"		"models/props_wasteland/barricade002a.mdl"
					"15"		"models/props_wasteland/barricade001a.mdl"
					"16"		"models/props_c17/concrete_barrier001a.mdl"
					"17"		"models/props_fortifications/concrete_barrier001_128_reference.mdl"
					"18"		"models/props_fortifications/concrete_barrier001_96_reference.mdl"
					"19"		"models/props_phx/construct/concrete_barrier00.mdl"
					"20"		"models/props_phx/construct/concrete_barrier01.mdl"
					"21"		"models/props_fortifications/barricade_razorwire001_128_reference.mdl"
					"22"		"models/props_fortifications/concrete_block001_128_reference.mdl"
					"23"		"models/props_fortifications/concrete_wall001_140_reference.mdl"
					"24"		"models/props_fortifications/police_barrier001_128_reference.mdl"
					"25"		"models/props_fortifications/traffic_barrier001.mdl"
					"26"		"models/props_fortifications/concrete_barrier001_96_reference.mdl"
					"27"		"models/props_fortifications/concrete_barrier001_96_reference.mdl"
					"28"		"models/props_fortifications/concrete_barrier001_96_reference.mdl"
				}
				"icon"		"icon16/bomb.png"
				"name"		"Apocalyptic"
			}
			"5"
			{
				"tooltip"		"Foggy Light Effect Props"
				"Models"
				{
					"1"		"models/effects/vol_light.mdl"
					"2"		"models/effects/vol_light01.mdl"
					"3"		"models/effects/vol_light02.mdl"
					"4"		"models/effects/vol_light128x128.mdl"
					"5"		"models/effects/vol_light128x256.mdl"
					"6"		"models/effects/vol_light128x384.mdl"
					"7"		"models/effects/vol_light128x512.mdl"
					"8"		"models/effects/vol_light256x512.mdl"
					"9"		"models/effects/vol_light64x128.mdl"
					"10"		"models/effects/vol_light64x256.mdl"
					"11"		"models/effects/lightshaft/lightshaft_2fortspawnext.mdl"
					"12"		"models/effects/lightshaft/lightshaft_window01.mdl"
					"13"		"models/lostcoast/effects/vollight_stainedglass.mdl"
					"14"		"models/props/cs_militia/bridgelight.mdl"
				}
				"icon"		"icon16/shading.png"
				"name"		"Light Effects"
			}
			"6"
			{
				"tooltip"		"Cabinets, Shelves, Urban Props"
				"Models"
				{
					"1"		"models/props_borealis/bluebarrel001.mdl"
					"2"		"models/props_interiors/Furniture_shelf01a.mdl"
					"3"		"models/props_junk/TrashDumpster02.mdl"
					"4"		"models/props_interiors/VendingMachineSoda01a.mdl"
					"5"		"models/props_wasteland/laundry_dryer001.mdl"
					"6"		"models/props_wasteland/laundry_dryer002.mdl"
					"7"		"models/props_wasteland/kitchen_stove002a.mdl"
					"8"		"models/props_wasteland/controlroom_storagecloset001b.mdl"
					"9"		"models/props_wasteland/medbridge_post01.mdl"
					"10"		"models/props_c17/signpole001.mdl"
					"11"		"models/props_trainstation/traincar_seats001.mdl"
					"12"		"models/props_vehicles/carparts_door01a.mdl"
					"13"		"models/props_lab/securitybank.mdl"
					"14"		"models/props_lab/reciever_cart.mdl"
					"15"		"models/props_lab/crematorcase.mdl"
					"16"		"models/props_lab/corkboard002.mdl"
					"17"		"models/props_lab/corkboard001.mdl"
					"18"		"models/props_lab/Cleaver.mdl"
					"19"		"models/props_lab/cactus.mdl"
					"20"		"models/props_trainstation/payphone001a.mdl"
					"21"		"models/props_lab/workspace003.mdl"
					"22"		"models/props_lab/workspace004.mdl"
					"23"		"models/props_lab/workspace002.mdl"
					"24"		"models/props_lab/workspace001.mdl"
					"25"		"models/props_lab/tpplugholder.mdl"
					"26"		"models/props_lab/tpplugholder_single.mdl"
					"27"		"models/props_lab/tpplug.mdl"
					"28"		"models/props_lab/servers.mdl"
					"29"		"models/props_vehicles/carparts_tire01a.mdl"
					"30"		"models/props_combine/combine_monitorbay.mdl"
					"31"		"models/props_combine/combine_interface001.mdl"
					"32"		"models/props_combine/combine_intmonitor001.mdl"
					"33"		"models/props_combine/CombineThumper002.mdl"
					"34"		"models/props_combine/CombineThumper001a.mdl"
					"35"		"models/props_combine/breendesk.mdl"
					"36"		"models/props_combine/combine_barricade_short02a.mdl"
					"37"		"models/props_combine/combine_bridge_b.mdl"
					"38"		"models/props_combine/combine_fence01a.mdl"
					"39"		"models/props_combine/combine_fence01b.mdl"
					"40"		"models/props_combine/weaponstripper.mdl"
					"41"		"models/nzprops/zombies_power_lever.mdl"
					"42"		"models/nzprops/zombies_power_lever_handle.mdl"
					"43"		"models/nzprops/zombies_power_lever_short.mdl"
					"44"		"models/props_c17/canister01a.mdl"
					"45"		"models/props_c17/canister02a.mdl"
					"46"		"models/props_c17/canister_propane01a.mdl"
					"47"		"models/props_c17/bench01a.mdl"
					"48"		"models/props_c17/chair02a.mdl"
					"49"		"models/props_c17/concrete_barrier001a.mdl"
					"50"		"models/props_c17/FurnitureChair001a.mdl"
					"51"		"models/props_c17/FurnitureCouch001a.mdl"
					"52"		"models/props_c17/FurnitureCouch002a.mdl"
					"53"		"models/props_c17/FurnitureCupboard001a.mdl"
					"54"		"models/props_c17/FurnitureDrawer001a.mdl"
					"55"		"models/props_c17/FurnitureDrawer002a.mdl"
					"56"		"models/props_c17/FurnitureDresser001a.mdl"
					"57"		"models/props_c17/FurnitureFridge001a.mdl"
					"58"		"models/props_c17/FurnitureRadiator001a.mdl"
					"59"		"models/props_c17/FurnitureShelf001a.mdl"
					"60"		"models/props_c17/furnitureStove001a.mdl"
					"61"		"models/props_c17/FurnitureWashingmachine001a.mdl"
					"62"		"models/props_c17/gravestone_cross001b.mdl"
					"63"		"models/props_c17/gravestone_statue001a.mdl"
					"64"		"models/props_c17/Lockers001a.mdl"
					"65"		"models/props_c17/oildrum001.mdl"
					"66"		"models/props_c17/shelfunit01a.mdl"
					"67"		"models/props_combine/breenchair.mdl"
					"68"		"models/props_interiors/Furniture_Couch01a.mdl"
					"69"		"models/props_interiors/Furniture_Couch02a.mdl"
					"70"		"models/props_junk/MetalBucket02a.mdl"
					"71"		"models/props_junk/metalgascan.mdl"
					"72"		"models/props_junk/PushCart01a.mdl"
					"73"		"models/props_junk/sawblade001a.mdl"
					"74"		"models/props_junk/TrashBin01a.mdl"
					"75"		"models/props_junk/TrashDumpster01a.mdl"
					"76"		"models/props_junk/wood_crate001a.mdl"
					"77"		"models/props_junk/wood_crate002a.mdl"
					"78"		"models/props_junk/wood_pallet001a.mdl"
					"79"		"models/props_lab/filecabinet02.mdl"
					"80"		"models/props_trainstation/trashcan_indoor001a.mdl"
					"81"		"models/props_trainstation/trashcan_indoor001b.mdl"
					"82"		"models/props_vehicles/tire001a_tractor.mdl"
					"83"		"models/props_vehicles/tire001b_truck.mdl"
					"84"		"models/props_vehicles/tire001c_car.mdl"
					"85"		"models/props_vehicles/apc_tire001.mdl"
					"86"		"models/props_wasteland/barricade001a.mdl"
					"87"		"models/props_wasteland/barricade002a.mdl"
					"88"		"models/props_wasteland/cargo_container01.mdl"
					"89"		"models/props_wasteland/cargo_container01b.mdl"
					"90"		"models/props_wasteland/laundry_washer003.mdl"
					"91"		"models/props_junk/garbage128_composite001a.mdl"
					"92"		"models/props_junk/garbage128_composite001b.mdl"
					"93"		"models/props_junk/garbage128_composite001c.mdl"
					"94"		"models/props_junk/garbage128_composite001d.mdl"
					"95"		"models/props_junk/garbage256_composite001a.mdl"
					"96"		"models/props_junk/garbage256_composite001b.mdl"
					"97"		"models/props_junk/garbage256_composite002a.mdl"
					"98"		"models/props_junk/garbage256_composite002b.mdl"
				}
				"icon"		"icon16/camera.png"
				"name"		"Scenery"
			}
			"7"
			{
				"tooltip"		"Broken Vehicles"
				"Models"
				{
					"1"		"models/props_canal/boat001a.mdl"
					"2"		"models/props_canal/boat001b.mdl"
					"3"		"models/props_canal/boat002b.mdl"
					"4"		"models/props_vehicles/car002a_physics.mdl"
					"5"		"models/props_vehicles/car001b_hatchback.mdl"
					"6"		"models/props_vehicles/car001a_hatchback.mdl"
					"7"		"models/props_vehicles/apc001.mdl"
					"8"		"models/props_vehicles/car002b_physics.mdl"
					"9"		"models/props_vehicles/car003a_physics.mdl"
					"10"		"models/props_vehicles/car003b_physics.mdl"
					"11"		"models/props_vehicles/car004a_physics.mdl"
					"12"		"models/props_vehicles/car004b_physics.mdl"
					"13"		"models/props_vehicles/car005a_physics.mdl"
					"14"		"models/props_vehicles/car005b_physics.mdl"
					"15"		"models/props_vehicles/tanker001a.mdl"
					"16"		"models/props_vehicles/generatortrailer01.mdl"
					"17"		"models/props_vehicles/trailer002a.mdl"
					"18"		"models/props_vehicles/truck001a.mdl"
					"19"		"models/props_vehicles/truck002a_cab.mdl"
					"20"		"models/props_vehicles/truck003a.mdl"
					"21"		"models/props_vehicles/van001a_physics.mdl"
				}
				"icon"		"icon16/car.png"
				"name"		"Vehicles"
			}
		}
	]]
end

function nzQMenu:CreatePropsMenu( )
	-- Data we will need later
	local data -- Table with spawnlist data
	local SpawnSheet -- Spawnlist sheet
	local UtilitySheet -- Utility sheet
	local CategoryEditor -- Function for creating Category Editor
	local ReloadSpawnlist -- Function for creating/reloading spawnlist sheet

	-- Create a Frame to contain everything.
	local frame = vgui.Create( "DFrame" )
	frame:SetTitle( "Props Menu" )
	frame:SetSize( 475, 340 )
	frame:Center()
	frame:SetPopupStayAtBack(true)
	frame:MakePopup()
	frame:ShowCloseButton( true )
	frame:SetVisible( false )
	frame.SpawnlistActive = true

	local oncolor = Color(255,255,255)
	local offcolor = Color(200,200,200)

	local utilitiestab -- Store it here so Spawntab can refer back to it

	local spawntab = vgui.Create("DPanel", frame)
	spawntab:SetPos(5,5)
	spawntab:SetSize(75,15)
	spawntab:SetBackgroundColor( oncolor )

	local spawntext = vgui.Create("DLabel", spawntab)
	spawntext:SetText("Spawnlist")
	spawntext:SetPos(14,-2)
	spawntext:SetTextColor( Color(10,10,10) )

	local spawnbut = vgui.Create("DButton", spawntab)
	spawnbut:SetSize(spawntab:GetSize())
	spawnbut:SetText("")
	spawnbut.Paint = function() end
	spawnbut.DoClick = function(self)
		UtilitySheet:SetVisible(false)
		SpawnSheet:SetVisible(true)
		spawntab:SetBackgroundColor( oncolor )
		utilitiestab:SetBackgroundColor( offcolor )
		frame.SpawnlistActive = true
	end

	utilitiestab = vgui.Create("DPanel", frame)
	utilitiestab:SetPos(85,5)
	utilitiestab:SetSize(75,15)
	utilitiestab:SetBackgroundColor( offcolor )

	local utilitiestext = vgui.Create("DLabel", utilitiestab)
	utilitiestext:SetText("Utilities")
	utilitiestext:SetPos(20,-2)
	utilitiestext:SetTextColor( Color(10,10,10) )

	local utilitiesbut = vgui.Create("DButton", utilitiestab)
	utilitiesbut:SetSize(utilitiestab:GetSize())
	utilitiesbut.Paint = function() end
	utilitiesbut:SetText("")
	utilitiesbut.DoClick = function(self)
		UtilitySheet:SetVisible(true)
		SpawnSheet:SetVisible(false)
		spawntab:SetBackgroundColor( offcolor )
		utilitiestab:SetBackgroundColor( oncolor )
		frame.SpawnlistActive = false
	end


	nzQMenu.Data.MainFrame = frame

	-- Loop to make all the tabs
	local tabs = {}
	tabs.Scrolls = {}
	tabs.Lists = {}
	tabs.Categories = {}

	CategoryEditor = function(oldcat, model)
		local frame = vgui.Create("DFrame")
		frame:SetTitle(oldcat and "Edit Category ..." or "Add Category ...")
		frame:SetSize(400, 250)
		frame:SetPos(ScrW()/2 - 200, ScrH()/2 - 125)

		local highlightcolor = Color(150,150,150)

		local name = vgui.Create( "DTextEntry", frame )
		name:SetSize( 380, 20 )
		name:SetPos( 10, 30 )
		if oldcat then
			name:SetValue(oldcat)
		end
		name.PaintOver = function(self, w, h)
			if self.HighlightRed then
				surface.SetDrawColor(255,0,0,self.HighlightRed)
				local x2,y2 = self:GetSize()
				surface.DrawRect(-50, -50, x2+50, y2+50)
				self.HighlightRed = self.HighlightRed - FrameTime() * 100
				if self.HighlightRed <= 0 then
					self.HighlightRed = nil
				end
			end
			if self:GetValue() == "" then
				draw.SimpleText("Name", "DermaDefault", 4, 3, highlightcolor)
			end
		end

		local tooltip = vgui.Create( "DTextEntry", frame )
		tooltip:SetSize( 380, 20 )
		tooltip:SetPos( 10, 55 )
		if oldcat then
			tooltip:SetValue(data[tabs.Categories[oldcat]].tooltip)
		end
		tooltip.PaintOver = function(self, w, h)
			if self:GetValue() == "" then
				draw.SimpleText("Tooltip (Optional)", "DermaDefault", 4, 3, highlightcolor)
			end
		end

		local icons = vgui.Create( "DIconBrowser", frame )
		icons:SetSize( 380, 130 )
		icons:SetPos( 10, 80 )
		if oldcat then
			icons:SetSelectedIcon(data[tabs.Categories[oldcat]].icon)
		else
			icons:SetSelectedIcon("icon16/accept.png")
		end

		local save = vgui.Create("DButton", frame)
		save:SetSize( 350, 25 )
		save:SetPos( 25, 215 )
		save:SetText(oldcat and "Save" or "Add")
		save.DoClick = function(self)
			local chosenname = name:GetValue()
			if chosenname == "" then
				name.HighlightRed = 255
			else
				local good = true
				if oldcat != chosenname then
					for k,v in pairs(data) do
						if v.name == chosenname then
							name.HighlightRed = 255
							good = false
							break
						end
					end
				end

				if good then
					if oldcat then
						local tbl = data[tabs.Categories[oldcat]]
						tbl.name = chosenname
						tbl.icon = icons:GetSelectedIcon()
						if tooltip:GetValue() != "" then
							tbl.tooltip = tooltip:GetValue()
						else
							tbl.tooltip = nil
						end
					else
						local tbl = {}
						if tooltip:GetValue() != "" then
							tbl.tooltip = tooltip:GetValue()
						end
						tbl.icon = icons:GetSelectedIcon()
						tbl.name = chosenname
						tbl.models = {}
						if model then table.insert(tbl.models, model) end
						table.insert(data, tbl)
					end
					ReloadSpawnlist()
					frame:Close()
				end
			end
		end

		frame:MakePopup()
	end

	ReloadSpawnlist = function()

		if IsValid(SpawnSheet) then SpawnSheet:Remove() end
		SpawnSheet = vgui.Create( "DPropertySheet", nzQMenu.Data.MainFrame )
		SpawnSheet:SetPos( 10, 30 )
		SpawnSheet:SetSize( 455, 300 )

		tabs.Scrolls = {}
		tabs.Lists = {}
		tabs.Categories = {}

		-- Then re-add from the data table
		for k,v in pairs(data) do
			local cat = v.name
			tabs.Scrolls[cat] = vgui.Create( "DScrollPanel", nzQMenu.Data.MainFrame )
			tabs.Scrolls[cat]:SetSize( 455, 300 )
			tabs.Scrolls[cat]:SetPos( 10, 30 )

			tabs.Lists[cat] = vgui.Create( "DIconLayout", tabs.Scrolls[cat] )
			tabs.Lists[cat]:SetSize( 440, 300 )
			tabs.Lists[cat]:SetPos( 0, 0 )
			tabs.Lists[cat]:SetSpaceY( 5 )
			tabs.Lists[cat]:SetSpaceX( 5 )
			local tab = SpawnSheet:AddSheet( cat, tabs.Scrolls[cat], v.icon, false, false, v.tooltip ).Tab
			tab.DoRightClick = function(self)
				local menu = DermaMenu()
				menu:AddOption("Edit Category ...", function()
					CategoryEditor(cat)
				end)
				local submenu = menu:AddSubMenu( "Set Order" )
				for i = 1, #data do
					submenu:AddOption(i, function()
						local temp = v
						table.remove(data, k)
						table.insert(data, i, v)
						ReloadSpawnlist()
					end)
				end

				menu:AddSpacer()

				menu:AddOption("Remove Category", function()
					table.remove(data, k)
					ReloadSpawnlist()
				end)
				menu:Open()
			end

			for k2,v2 in pairs(v.models) do
				local ListItem = tabs.Lists[cat]:Add( "SpawnIcon" )
				ListItem:SetSize( 48, 48 )

				local v2Fix = isentity(v2) and k2 or v2
				ListItem:SetModel(v2Fix)
				ListItem.Model = v2
				ListItem.DoClick = function( item )
					nzQMenu:Request(item.Model)
					surface.PlaySound( "ui/buttonclickrelease.wav" )
				end
				ListItem.DoRightClick = function( item )
					local menu = DermaMenu()
					local submenu = menu:AddSubMenu( "Add to category" )

					for k3,v3 in pairs(data) do
						submenu:AddOption(v3.name, function()
							table.insert(v3.models, v2)
							ReloadSpawnlist()
						end)
					end

					menu:AddOption("Add to new category ...", function()
						local v2Fix = isentity(v2) and k2 or v2
						CategoryEditor(nil, v2Fix)
					end)

					menu:AddSpacer()

					menu:AddOption("Remove from category", function()
						table.remove(v.models, k2)
						ReloadSpawnlist()
					end)

					menu:AddSpacer()
					menu:AddOption("Copy to clipboard", function()
						SetClipboardText(v2)
					end)

					menu:Open()
				end
			end
			tabs.Categories[cat] = k
		end

		if !frame.SpawnlistActive then
			SpawnSheet:SetVisible(false)
		end
	end

	tabs.Utilities = {}
	local function CreateUtilities()
		if IsValid(UtilitySheet) then UtilitySheet:Remove() end
		UtilitySheet = vgui.Create( "DPropertySheet", nzQMenu.Data.MainFrame )
		UtilitySheet:SetPos( 10, 30 )
		UtilitySheet:SetSize( 455, 300 )

		tabs.Utilities["Entities"] = vgui.Create( "DScrollPanel", nzQMenu.Data.MainFrame )
		tabs.Utilities["Entities"]:SetSize( 455, 300 )
		tabs.Utilities["Entities"]:SetPos( 10, 30 )

		local lists = vgui.Create( "DIconLayout", tabs.Utilities["Entities"] )
		lists:SetSize( 440, 300 )
		lists:SetPos( 0, 0 )
		lists:SetSpaceY( 5 )
		lists:SetSpaceX( 5 )
		tabs.Utilities["Entities"].List = lists
		UtilitySheet:AddSheet( "Entities", tabs.Utilities["Entities"], nil, false, false, v )

		tabs.Utilities["Search"] = vgui.Create( "DPanel", nzQMenu.Data.MainFrame )
		tabs.Utilities["Search"]:SetSize( 455, 300 )
		tabs.Utilities["Search"]:SetPos( 10, 30 )

		tabs.Utilities["Search"].Warn = vgui.Create( "DLabel", tabs.Utilities["Search"] )
		tabs.Utilities["Search"].Warn:SetSize( 420, 20 )
		tabs.Utilities["Search"].Warn:SetPos( 60, 5 )
		tabs.Utilities["Search"].Warn:SetTextColor( Color(0,0,0) )
		tabs.Utilities["Search"].Warn:SetText("Warning: May cause severe lag and/or crash. Be sure to save first.")

		tabs.Utilities["Search"].Search = vgui.Create( "DTextEntry", tabs.Utilities["Search"] )
		tabs.Utilities["Search"].Search:SetSize( 420, 20 )
		tabs.Utilities["Search"].Search:SetPos( 10, 25 )
		tabs.Utilities["Search"].Search.OnEnter = function() tabs.Utilities["Search"]:RefreshResults() end
		tabs.Utilities["Search"].Search:SetTooltip("Press Enter to search/update results")

		tabs.Utilities["Search"].Content = vgui.Create( "DScrollPanel", tabs.Utilities["Search"] )
		tabs.Utilities["Search"].Content:SetSize( 430, 210 )
		tabs.Utilities["Search"].Content:SetPos( 0, 50 )

		lists = vgui.Create( "DIconLayout", tabs.Utilities["Search"].Content )
		lists:SetSize( 440, 210 )
		lists:SetPos( 10, 00 )
		lists:SetSpaceY( 5 )
		lists:SetSpaceX( 5 )
		tabs.Utilities["Search"].List = lists

		tabs.Utilities["MapProps"] = vgui.Create( "DPanel", nzQMenu.Data.MainFrame )
		tabs.Utilities["MapProps"]:SetSize( 455, 300 )
		tabs.Utilities["MapProps"]:SetPos( 10, 30 )

		tabs.Utilities["MapProps"].Search = vgui.Create( "DButton", tabs.Utilities["MapProps"] )
		tabs.Utilities["MapProps"].Search:SetSize( 420, 20 )
		tabs.Utilities["MapProps"].Search:SetPos( 10, 10 )
		tabs.Utilities["MapProps"].Search.DoClick = function() tabs.Utilities["MapProps"]:RefreshResults() end
		tabs.Utilities["MapProps"].Search:SetText("Update")

		tabs.Utilities["MapProps"].Content = vgui.Create( "DScrollPanel", tabs.Utilities["MapProps"] )
		tabs.Utilities["MapProps"].Content:SetSize( 430, 220 )
		tabs.Utilities["MapProps"].Content:SetPos( 0, 40 )

		lists = vgui.Create( "DIconLayout", tabs.Utilities["MapProps"].Content )
		lists:SetSize( 440, 210 )
		lists:SetPos( 10, 00 )
		lists:SetSpaceY( 5 )
		lists:SetSpaceX( 5 )
		tabs.Utilities["MapProps"].List = lists

		function tabs.Utilities.Search:RefreshResults()
			if ( self.Search:GetText() == "" ) then return end
			local pnl = tabs.Utilities["Search"].List
			pnl:Clear()
			local results = search.GetResults( self.Search:GetText() )
			for k,v in pairs(results) do
				local ListItem = pnl:Add( "SpawnIcon" )
				ListItem:SetSize( 45, 45 )
				ListItem:SetModel(v)
				ListItem.Model = v
				ListItem.DoClick = function( item )
					nzQMenu:Request(item.Model)
					surface.PlaySound( "ui/buttonclickrelease.wav" )
				end
				ListItem.DoRightClick = function( item )
					local menu = DermaMenu()
					local submenu = menu:AddSubMenu( "Add to category" )
					for k2,v2 in pairs(data) do
						submenu:AddOption(v2.name, function()
							table.insert(v2.models, v)
							ReloadSpawnlist()
						end)
					end

					menu:AddSpacer()

					menu:AddOption("Add to new category ...", function()
						CategoryEditor(nil, v)
					end)

					menu:AddSpacer()
					menu:AddOption("Copy to clipboard", function()
						SetClipboardText(v)
					end)

					menu:Open()
				end
			end
		end

		function tabs.Utilities.MapProps:RefreshResults()
			local pnl = tabs.Utilities["MapProps"].List
			pnl:Clear()
			local used = {}
			for k,v in pairs(ents.GetAll()) do
				if string.find(v:GetClass(), "prop") then
					local model = v:GetModel()
					if !used[model] then
						local ListItem = pnl:Add( "SpawnIcon" )
						ListItem:SetSize( 45, 45 )
						ListItem:SetModel(model)
						ListItem.Model = model
						ListItem.DoClick = function( item )
							nzQMenu:Request(item.Model)
							surface.PlaySound( "ui/buttonclickrelease.wav" )
						end
						ListItem.DoRightClick = function( item )
							local menu = DermaMenu()
							local submenu = menu:AddSubMenu( "Add to category" )
							for k,v in pairs(data) do
								submenu:AddOption(v.name, function()
									table.insert(v.models, model)
									ReloadSpawnlist()
								end)
							end

							menu:AddSpacer()

							menu:AddOption("Add to new category ...", function()
								CategoryEditor(nil, v)
							end)

							menu:AddSpacer()
							menu:AddOption("Copy to clipboard", function()
								SetClipboardText(model)
							end)

							menu:Open()
						end
						used[model] = true
					end
				end
			end
		end

		UtilitySheet:AddSheet( "Map Props", tabs.Utilities["MapProps"], "icon16/map.png", false, false, v )
		UtilitySheet:AddSheet( "Search", tabs.Utilities["Search"], "icon16/magnifier.png", false, false, v )

		for k,v in pairs(nzQMenu.Data.Entities) do
			local ListItem = tabs.Utilities["Entities"].List:Add( "DImageButton" )
			ListItem:SetSize( 48, 48 )
			ListItem:SetImage(v[2])
			ListItem.Entity = v[1]
			ListItem.DoClick = function( item )
				nzQMenu:Request(item.Entity, true)
				surface.PlaySound( "ui/buttonclickrelease.wav" )
			end
			ListItem:SetTooltip(v[3] or v[1])
			-- You don't need to set the position, that is done automatically

		end

		tabs.Utilities["Addons"] = vgui.Create( "DPanel", nzQMenu.Data.MainFrame )
		tabs.Utilities["Addons"]:SetSize( 455, 300 )
		tabs.Utilities["Addons"]:SetPos( 0, 30 )

		tabs.Utilities["Addons"].AddonList = vgui.Create( "DTree", tabs.Utilities["Addons"] )
		tabs.Utilities["Addons"].AddonList:SetSize(200, 280)
		tabs.Utilities["Addons"].AddonList:SetPos(-20, 0)
		tabs.Utilities["Addons"].AddonList:SetPadding(0)

		tabs.Utilities["Addons"].Content = vgui.Create( "DScrollPanel", tabs.Utilities["Addons"] )
		tabs.Utilities["Addons"].Content:SetSize( 330, 220 )
		tabs.Utilities["Addons"].Content:SetPos( 180, 10 )

		lists = vgui.Create( "DIconLayout", tabs.Utilities["Addons"].Content )
		lists:SetSize( 340, 210 )
		lists:SetPos( 10, 0 )
		lists:SetSpaceY( 5 )
		lists:SetSpaceX( 5 )
		tabs.Utilities["Addons"].List = lists

		-- From Sandbox
		local function AddRecursive( pnl, folder, path, wildcard )
			local files, folders = file.Find( folder .. "*", path )
			for k, v in pairs( files ) do
				if ( !string.EndsWith( v, ".mdl" ) ) then continue end

				local model = folder..v

				local ListItem = pnl:Add( "SpawnIcon" )
				ListItem:SetSize( 45, 45 )
				ListItem:SetModel(model)
				ListItem.Model = model
				ListItem.DoClick = function( item )
					nzQMenu:Request(item.Model)
					surface.PlaySound( "ui/buttonclickrelease.wav" )
				end
				ListItem.DoRightClick = function( item )
					local menu = DermaMenu()
					local submenu = menu:AddSubMenu( "Add to category" )
					for k2,v2 in pairs(data) do
						submenu:AddOption(v2.name, function()
							table.insert(v2.models, model)
							ReloadSpawnlist()
						end)
					end

					menu:AddSpacer()

					menu:AddOption("Add to new category ...", function()
						CategoryEditor(nil, model)
					end)
					menu:Open()
				end

			end
			for k, v in pairs( folders ) do
				AddRecursive( pnl, folder .. v .. "/", path, wildcard )
			end
		end

		for _, addon in SortedPairsByMemberValue( engine.GetAddons(), "title" ) do
			if ( !addon.downloaded || !addon.mounted ) then continue end
			if ( addon.models <= 0 ) then continue end

			local models = tabs.Utilities["Addons"].AddonList:AddNode( addon.title .. " (" .. addon.models .. ")", "icon16/bricks.png" )
			models.DoClick = function()

				local pnl = tabs.Utilities["Addons"].List
				pnl:Clear()

				AddRecursive(pnl, "models/", addon.title, "*.mdl")

			end
		end

		UtilitySheet:AddSheet( "Addons", tabs.Utilities["Addons"], "icon16/bricks.png", false, false, v )

		if !frame.SpawnlistActive then
			UtilitySheet:SetVisible(false)
		end
	end

	local empty = !file.Exists( "nz/spawnlist.txt", "DATA" )
	if !empty then
		empty = #file.Read("nz/spawnlist.txt") == 0
	end

	if empty then
		if !file.Exists( "nz/", "DATA" ) then
			file.CreateDir( "nz" )
		end
		--local content = file.Read("nzmapscripts/defaultspawnlist.lua", "LUA") -- Get that shit outta here (if they are missing the first file, they are probably missing this too..) /Ethorbit
		local content = nzQMenu.GetDefaultPropList()
		file.Write("nz/spawnlist.txt", content)
	end

	local content = file.Read( "nz/spawnlist.txt", "DATA" )
	if content then
		data = util.KeyValuesToTable(content)
		ReloadSpawnlist()
		CreateUtilities()
		UtilitySheet:SetVisible(false) -- This starts off
	end

	hook.Add( "SearchUpdate", "SearchUpdate", function()
		if ( !tabs.Utilities["Search"]:IsVisible() ) then return end
		tabs.Utilities["Search"]:RefreshResults()
	end)

	local save = vgui.Create("DButton", frame)
	save:SetPos(325, 4)
	save:SetSize(50, 16)
	save:SetText("Save")
	save.DoClick = function()
		local tbl = {}
		for k,v in pairs(data) do
			table.insert(tbl, v)
		end
		local keyvalues = util.TableToKeyValues(tbl)
		file.Write("nz/spawnlist.txt", keyvalues)
	end

end

function nzQMenu:CreateToolsMenu( )
	-- Create a Frame to contain everything.
	nzQMenu.Data.MainFrame = vgui.Create( "DFrame" )
	--nzQMenu.Data.MainFrame:SetTitle( "Tools Menu" )
	nzQMenu.Data.MainFrame:SetSize( 700, 500 )
	nzQMenu.Data.MainFrame:Center()
	nzQMenu.Data.MainFrame:MakePopup()
	nzQMenu.Data.MainFrame:ShowCloseButton( true )
	nzQMenu.Data.MainFrame:SetTitle("")
	nzQMenu.Data.MainFrame.Paint = function(self, w, h) end
	nzQMenu.Data.MainFrame.ToolMode = true
	nzQMenu.Data.MainFrame:MakePopup()

	local ToolPanel = vgui.Create("DFrame", nzQMenu.Data.MainFrame )
	ToolPanel:SetPos( 505, 25 )
	ToolPanel:SetSize( 255, 500 )
	ToolPanel:SetZPos(-30)
	ToolPanel:ShowCloseButton(false)
	ToolPanel:SetDraggable(false)
	ToolPanel:SetTitle("Tool List")

	local ToolInterface = vgui.Create("DFrame", nzQMenu.Data.MainFrame )
	ToolInterface:SetPos( 0, 0 )
	ToolInterface:SetSize( 510, 500 )
	ToolInterface:ShowCloseButton(false)
	ToolInterface:SetDraggable(false)
	ToolInterface:SetTitle(nzTools.ToolData[LocalPlayer():GetActiveWeapon().ToolMode or "default"].displayname)

	local FrameMerge = vgui.Create("DPanel", nzQMenu.Data.MainFrame )
	FrameMerge:SetPos( 508, 49 )
	FrameMerge:SetSize( 4, 235 )
	FrameMerge.Paint = function(self, w, h)
		surface.SetDrawColor(96, 100, 103)
		surface.DrawRect(0, 0, w, h)
	end

	local ToolList = vgui.Create( "DScrollPanel", nzQMenu.Data.MainFrame )
	ToolList:SetPos( 505, 58 )
	ToolList:SetSize( 190, 440 )

	local ToolData = vgui.Create("DPanel", ToolInterface )
	ToolData:SetPos( 5, 30 )
	ToolData:SetSize( 500, 500 )

	-- Loop to make all the tabs
	local tabs = {}
	tabs.Tools = {}
	local curtool = nil
	local numtools = 0

	local function RebuildToolInterface(id)
		if (MapSDermaButton != nil ) then
			MapSDermaButton:Remove()
		end

		--print(ToolData.interface)
		if nzTools.ToolData[id] then
			if ToolData.interface then ToolData.interface:Remove() end
			ToolData.interface = nzTools.ToolData[id].interface(ToolData, nzTools.SavedData[id])

			if tabs.Tools[curtool] then tabs.Tools[curtool]:SetBackgroundColor( Color(150, 150, 150) ) end
			if tabs.Tools[id] then tabs.Tools[id]:SetBackgroundColor( Color(255, 255, 255) ) end
			ToolInterface:SetTitle(nzTools.ToolData[id or "default"].displayname)
			curtool = id

			if !IsValid(ToolData.interface) then
				ToolData.interface = vgui.Create("DLabel", ToolData)
				ToolData.interface:SetText("This tool does not have any properties.")
				ToolData.interface:SetFont("Trebuchet18")
				ToolData.interface:SetTextColor( Color(50, 50, 50) )
				ToolData.interface:SizeToContents()
				ToolData.interface:Center()
			return end
		end
	end

	local function RebuildToolList()
		for k,v in pairs(tabs.Tools) do
			v:Remove()
			numtools = 0
		end
		local tbl = {}

		-- Create a new cloned table that we can sort by weight
		for k,v in pairs(nzTools.ToolData) do
			if !nzTools.SavedData[k] then
				nzTools.SavedData[k] = v.defaultdata
			end
			local num = table.insert(tbl, v)
			tbl[num].id = k
		end
		table.SortByMember(tbl, "weight", true)

		for k,v in pairs(tbl) do
			if v.condition(LocalPlayer():GetActiveWeapon(), LocalPlayer()) then
				tabs.Tools[v.id] = vgui.Create("DPanel", ToolList)
				tabs.Tools[v.id]:SetSize(245, 20)
				tabs.Tools[v.id]:SetPos(0, 0 + numtools*22)
				tabs.Tools[v.id]:SetZPos(30000)
				if LocalPlayer():GetActiveWeapon().ToolMode and LocalPlayer():GetActiveWeapon().ToolMode == k then
					tabs.Tools[v.id]:SetBackgroundColor( Color(255, 255, 255) )
					RebuildToolInterface(v.id)
				else
					tabs.Tools[v.id]:SetBackgroundColor( Color(150, 150, 150) )
				end

				local icon = vgui.Create("DImage", tabs.Tools[v.id])
				icon:SetImage(v.icon)
				icon:SetPos(3,3)
				icon:SizeToContents()

				local tooltext = vgui.Create("DLabel", tabs.Tools[v.id])
				tooltext:SetText(v.displayname)
				tooltext:SetTextColor( Color(10, 10, 10) )
				tooltext:SetPos(24,3)
				tooltext:SizeToContents()

				local toolbutton = vgui.Create("DButton", tabs.Tools[v.id])
				toolbutton:SetPos(0,0)
				toolbutton:SetSize(145, 20)
				toolbutton:SetText("")
				toolbutton.Paint = function() end
				toolbutton.DoClick = function()
					local wep = LocalPlayer():GetActiveWeapon()
					if wep and wep:GetClass() == "nz_multi_tool" then
						LocalPlayer():GetActiveWeapon():SwitchTool(v.id)
						RebuildToolInterface(v.id)
					end
				end

				numtools = numtools + 1
			end
		end
	end
	RebuildToolList()
	RebuildToolInterface(LocalPlayer():GetActiveWeapon().ToolMode or "default")

	ToolInterface.OnFocusChanged = function(self, bool)
		if bool then
			-- Keep the design here, the buttons are supposed to leak into the main frame
			self:SetZPos(-10)
		end
	end

	local advanced = vgui.Create("DCheckBoxLabel", ToolInterface)
	advanced:SetPos(400, 6)
	advanced:SetText("Advanced Mode")
	advanced:SetValue(nzTools.Advanced)
	advanced:SizeToContents()
	advanced.OnChange = function(self)
		nzTools.Advanced = self:GetChecked()
		RebuildToolList()
		RebuildToolInterface(LocalPlayer():GetActiveWeapon().ToolMode or "default")
	end

end

function nzQMenu:Open()
	-- Check if we're in create mode
	if nzRound:InState( ROUND_CREATE ) and LocalPlayer():IsInCreative() then
		if !IsValid(nzQMenu.Data.MainFrame) then
			if IsValid(LocalPlayer():GetActiveWeapon()) and LocalPlayer():GetActiveWeapon():GetClass() == "nz_multi_tool" then
				nzQMenu:CreateToolsMenu()
			else
				nzQMenu:CreatePropsMenu()
			end
		end

		-- If the toolgun is equipped and the menu isn't the toolmenu or vice versa, recreate
		if IsValid(LocalPlayer():GetActiveWeapon()) and LocalPlayer():GetActiveWeapon():GetClass() == "nz_multi_tool" and !nzQMenu.Data.MainFrame.ToolMode then
			nzQMenu.Data.MainFrame:Remove()
			nzQMenu:CreateToolsMenu()
		elseif IsValid(LocalPlayer():GetActiveWeapon()) and LocalPlayer():GetActiveWeapon():GetClass() != "nz_multi_tool" and nzQMenu.Data.MainFrame.ToolMode then
			nzQMenu.Data.MainFrame:Remove()
			nzQMenu:CreatePropsMenu()
		end

		nzQMenu.Data.MainFrame:SetVisible( true )
	end
end

local textentryfocus = false

function nzQMenu:Close()

	-- We don't want to close if we're currently typing
	if textentryfocus then return end

	if !IsValid(nzQMenu.Data.MainFrame) then
		if IsValid(LocalPlayer():GetActiveWeapon()) and LocalPlayer():GetActiveWeapon():GetClass() == "nz_multi_tool" then
			nzQMenu:CreateToolsMenu()
		else
			nzQMenu:CreatePropsMenu()
		end
	end

	nzQMenu.Data.MainFrame:SetVisible( false )
	nzQMenu.Data.MainFrame:KillFocus()
	nzQMenu.Data.MainFrame:SetKeyboardInputEnabled(false)
	textentryfocus = false
end

hook.Add( "OnSpawnMenuOpen", "OpenSpawnMenu", nzQMenu.Open )
hook.Add( "OnSpawnMenuClose", "CloseSpawnMenu", nzQMenu.Close )

hook.Add( "OnTextEntryGetFocus", "StartTextFocus", function(panel)
	textentryfocus = true
	if IsValid(nzQMenu.Data.MainFrame) then
		nzQMenu.Data.MainFrame:SetKeyboardInputEnabled(true)
	end
end )
hook.Add( "OnTextEntryLoseFocus", "EndTextFocus", function(panel)
	textentryfocus = false
	TextEntryLoseFocus()
	if IsValid(nzQMenu.Data.MainFrame) then
		nzQMenu.Data.MainFrame:KillFocus()
		nzQMenu.Data.MainFrame:SetKeyboardInputEnabled(false)
	end
end )
